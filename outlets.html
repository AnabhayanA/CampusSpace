<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Find Outlets | CampusSpace</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <style>
    * {
      font-family: 'Poppins', sans-serif;
    }
    
    body {
      background: #f8f9fa;
      padding-bottom: 80px;
    }
    
    .outlet-card {
      transition: all 0.3s;
      cursor: pointer;
      border-left: 4px solid #dee2e6;
    }
    
    .outlet-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .outlet-card.available {
      border-left-color: #198754;
    }
    
    .outlet-card.occupied {
      border-left-color: #dc3545;
    }
    
    .outlet-card.out-of-service {
      border-left-color: #ffc107;
    }
    
    .outlet-type-badge {
      font-size: 0.75rem;
      padding: 0.25rem 0.5rem;
    }
    
    .stats-card {
      background: linear-gradient(135deg, #b31b1b 0%, #ff2c2c 100%);
      color: white;
      border: none;
    }
    
    .search-box {
      border-radius: 50px;
      padding: 12px 20px;
    }
    
    #map {
      height: 400px;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
      padding: 10px 0;
      z-index: 1000;
    }
    
    .nav-item {
      text-align: center;
      color: #6c757d;
      text-decoration: none;
      transition: color 0.3s;
    }
    
    .nav-item:hover, .nav-item.active {
      color: #b31b1b;
    }
    
    .report-modal textarea {
      resize: vertical;
    }
  </style>
</head>
<body>
  <!-- Header -->
  <nav class="navbar navbar-light bg-white shadow-sm mb-4">
    <div class="container">
      <a class="navbar-brand" href="dashboard.html">
        <i class="bi bi-arrow-left"></i> CampusSpace
      </a>
      <span class="navbar-text">
        <i class="bi bi-plug-fill text-danger"></i> Outlets
      </span>
    </div>
  </nav>

  <div class="container">
    <!-- Stats Row -->
    <div class="row mb-4">
      <div class="col-md-3 col-6 mb-3">
        <div class="card stats-card">
          <div class="card-body text-center">
            <h3 id="total-outlets">0</h3>
            <small>Total Outlets</small>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-6 mb-3">
        <div class="card text-white bg-success">
          <div class="card-body text-center">
            <h3 id="available-outlets">0</h3>
            <small>Available</small>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-6 mb-3">
        <div class="card text-white bg-danger">
          <div class="card-body text-center">
            <h3 id="occupied-outlets">0</h3>
            <small>Occupied</small>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-6 mb-3">
        <div class="card text-white bg-warning">
          <div class="card-body text-center">
            <h3 id="broken-outlets">0</h3>
            <small>Out of Service</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Map -->
    <div id="map"></div>

    <!-- Search and Filters -->
    <div class="card mb-4">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-4">
            <input type="text" id="search-box" class="form-control search-box" placeholder="ðŸ” Search outlets...">
          </div>
          <div class="col-md-2">
            <select id="building-filter" class="form-select">
              <option value="">All Buildings</option>
            </select>
          </div>
          <div class="col-md-2">
            <select id="type-filter" class="form-select">
              <option value="">All Types</option>
              <option value="standard">Standard</option>
              <option value="usb">USB</option>
              <option value="usb-c">USB-C</option>
              <option value="combination">Combination</option>
            </select>
          </div>
          <div class="col-md-2">
            <select id="status-filter" class="form-select">
              <option value="">All Status</option>
              <option value="available">Available</option>
              <option value="occupied">Occupied</option>
              <option value="out-of-service">Out of Service</option>
            </select>
          </div>
          <div class="col-md-2">
            <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
              <i class="bi bi-arrow-clockwise"></i> Reset
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Outlets List -->
    <div id="outlets-container" class="row">
      <!-- Outlets will be loaded here -->
    </div>

    <div id="no-results" class="text-center py-5" style="display:none;">
      <i class="bi bi-inbox" style="font-size: 4rem; color: #dee2e6;"></i>
      <h4 class="mt-3 text-muted">No outlets found</h4>
      <p class="text-muted">Try adjusting your filters</p>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <div class="container">
      <div class="row text-center">
        <div class="col">
          <a href="dashboard.html" class="nav-item d-block">
            <i class="bi bi-house-door fs-4"></i>
            <div style="font-size: 0.7rem;">Home</div>
          </a>
        </div>
        <div class="col">
          <a href="outlets.html" class="nav-item d-block active">
            <i class="bi bi-plug-fill fs-4"></i>
            <div style="font-size: 0.7rem;">Outlets</div>
          </a>
        </div>
        <div class="col">
          <a href="profile.html" class="nav-item d-block">
            <i class="bi bi-person fs-4"></i>
            <div style="font-size: 0.7rem;">Profile</div>
          </a>
        </div>
        <div class="col">
          <a href="settings.html" class="nav-item d-block">
            <i class="bi bi-gear fs-4"></i>
            <div style="font-size: 0.7rem;">Settings</div>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Report Modal -->
  <div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Report Outlet Status</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="report-outlet-id">
          <div class="mb-3">
            <label class="form-label">Outlet</label>
            <input type="text" id="report-outlet-name" class="form-control" readonly>
          </div>
          <div class="mb-3">
            <label class="form-label">Status</label>
            <select id="report-status" class="form-select">
              <option value="available">Available</option>
              <option value="occupied">Occupied</option>
              <option value="broken">Broken</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Comment (optional)</label>
            <textarea id="report-comment" class="form-control report-modal" rows="3" placeholder="Additional details..."></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" onclick="submitReport()">Submit Report</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <script>
    const API_BASE = 'http://localhost:3000/api';
    let allOutlets = [];
    let map, markersLayer;
    let reportModal;

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      initMap();
      loadOutlets();
      setupFilters();
      reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
    });

    function initMap() {
      map = L.map('map').setView([40.7425, -74.177], 16);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
      }).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
    }

    async function loadOutlets() {
      try {
        const response = await fetch(`${API_BASE}/outlets`);
        const data = await response.json();
        
        if (data.success) {
          allOutlets = data.data;
          displayOutlets(allOutlets);
          updateStats(allOutlets);
          populateBuildingFilter(allOutlets);
          updateMap(allOutlets);
        }
      } catch (error) {
        console.error('Error loading outlets:', error);
        // Show sample data message
        document.getElementById('outlets-container').innerHTML = `
          <div class="col-12">
            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i> 
              Database not connected. Install MongoDB and run <code>npm run seed-outlets</code> to add sample outlet data.
            </div>
          </div>
        `;
      }
    }

    function displayOutlets(outlets) {
      const container = document.getElementById('outlets-container');
      const noResults = document.getElementById('no-results');
      
      if (outlets.length === 0) {
        container.innerHTML = '';
        noResults.style.display = 'block';
        return;
      }
      
      noResults.style.display = 'none';
      container.innerHTML = outlets.map(outlet => `
        <div class="col-md-6 col-lg-4 mb-3">
          <div class="card outlet-card ${outlet.status}" onclick="showOutletDetails('${outlet._id}')">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <h6 class="card-title mb-0">
                  <i class="bi bi-plug-fill"></i> ${outlet.room}
                </h6>
                <span class="badge ${getStatusBadgeClass(outlet.status)}">
                  ${outlet.status.replace('-', ' ')}
                </span>
              </div>
              
              <p class="text-muted small mb-2">
                <i class="bi bi-building"></i> ${outlet.building} - Floor ${outlet.floor}
              </p>
              
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="outlet-type-badge badge bg-secondary">
                  ${getOutletTypeIcon(outlet.type)} ${outlet.type}
                </span>
                <span class="small">
                  ${outlet.availablePorts}/${outlet.totalPorts} ports
                </span>
              </div>
              
              <div class="progress mb-2" style="height: 6px;">
                <div class="progress-bar ${getProgressBarClass(outlet)}" 
                     style="width: ${(outlet.availablePorts / outlet.totalPorts) * 100}%">
                </div>
              </div>
              
              ${outlet.notes ? `<p class="small text-muted mb-2"><i class="bi bi-info-circle"></i> ${outlet.notes}</p>` : ''}
              
              <div class="d-flex justify-content-between align-items-center">
                <small class="text-muted">
                  ${outlet.isVerified ? '<i class="bi bi-check-circle-fill text-success"></i> Verified' : '<i class="bi bi-question-circle"></i> Unverified'}
                </small>
                <button class="btn btn-sm btn-outline-danger" onclick="openReportModal('${outlet._id}', '${outlet.room}', event)">
                  <i class="bi bi-flag"></i> Report
                </button>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function updateMap(outlets) {
      markersLayer.clearLayers();
      
      outlets.forEach(outlet => {
        if (outlet.location && outlet.location.coordinates) {
          const [lng, lat] = outlet.location.coordinates;
          if (lat !== 0 && lng !== 0) {
            const icon = L.divIcon({
              className: 'custom-marker',
              html: `<div style="background: ${getMarkerColor(outlet.status)}; width: 30px; height: 30px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center; color: white; font-size: 14px;">
                <i class="bi bi-plug-fill"></i>
              </div>`,
              iconSize: [30, 30]
            });
            
            L.marker([lat, lng], { icon })
              .bindPopup(`
                <strong>${outlet.room}</strong><br>
                ${outlet.building} - Floor ${outlet.floor}<br>
                <span class="badge ${getStatusBadgeClass(outlet.status)}">${outlet.status}</span><br>
                ${outlet.availablePorts}/${outlet.totalPorts} ports available
              `)
              .addTo(markersLayer);
          }
        }
      });
    }

    function updateStats(outlets) {
      document.getElementById('total-outlets').textContent = outlets.length;
      document.getElementById('available-outlets').textContent = 
        outlets.filter(o => o.status === 'available').length;
      document.getElementById('occupied-outlets').textContent = 
        outlets.filter(o => o.status === 'occupied').length;
      document.getElementById('broken-outlets').textContent = 
        outlets.filter(o => o.status === 'out-of-service').length;
    }

    function populateBuildingFilter(outlets) {
      const buildings = [...new Set(outlets.map(o => o.building))].sort();
      const select = document.getElementById('building-filter');
      buildings.forEach(building => {
        const option = document.createElement('option');
        option.value = building;
        option.textContent = building;
        select.appendChild(option);
      });
    }

    function setupFilters() {
      const searchBox = document.getElementById('search-box');
      const buildingFilter = document.getElementById('building-filter');
      const typeFilter = document.getElementById('type-filter');
      const statusFilter = document.getElementById('status-filter');
      
      [searchBox, buildingFilter, typeFilter, statusFilter].forEach(el => {
        el.addEventListener('change', applyFilters);
        el.addEventListener('keyup', applyFilters);
      });
    }

    function applyFilters() {
      const search = document.getElementById('search-box').value.toLowerCase();
      const building = document.getElementById('building-filter').value;
      const type = document.getElementById('type-filter').value;
      const status = document.getElementById('status-filter').value;
      
      const filtered = allOutlets.filter(outlet => {
        const matchesSearch = !search || 
          outlet.room.toLowerCase().includes(search) ||
          outlet.building.toLowerCase().includes(search) ||
          (outlet.notes && outlet.notes.toLowerCase().includes(search));
        const matchesBuilding = !building || outlet.building === building;
        const matchesType = !type || outlet.type === type;
        const matchesStatus = !status || outlet.status === status;
        
        return matchesSearch && matchesBuilding && matchesType && matchesStatus;
      });
      
      displayOutlets(filtered);
      updateMap(filtered);
    }

    function resetFilters() {
      document.getElementById('search-box').value = '';
      document.getElementById('building-filter').value = '';
      document.getElementById('type-filter').value = '';
      document.getElementById('status-filter').value = '';
      displayOutlets(allOutlets);
      updateMap(allOutlets);
    }

    function openReportModal(outletId, outletName, event) {
      event.stopPropagation();
      document.getElementById('report-outlet-id').value = outletId;
      document.getElementById('report-outlet-name').value = outletName;
      reportModal.show();
    }

    async function submitReport() {
      const outletId = document.getElementById('report-outlet-id').value;
      const status = document.getElementById('report-status').value;
      const comment = document.getElementById('report-comment').value;
      
      try {
        const response = await fetch(`${API_BASE}/outlets/${outletId}/report`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: 'user-' + Date.now(),
            status,
            comment
          })
        });
        
        const data = await response.json();
        
        if (data.success) {
          alert('Report submitted successfully!');
          reportModal.hide();
          loadOutlets();
        } else {
          alert('Failed to submit report. Please try again.');
        }
      } catch (error) {
        console.error('Error submitting report:', error);
        alert('Error submitting report. Please check if MongoDB is running.');
      }
    }

    function showOutletDetails(outletId) {
      const outlet = allOutlets.find(o => o._id === outletId);
      if (outlet && outlet.location && outlet.location.coordinates) {
        const [lng, lat] = outlet.location.coordinates;
        if (lat !== 0 && lng !== 0) {
          map.setView([lat, lng], 18);
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }
      }
    }

    // Helper functions
    function getStatusBadgeClass(status) {
      const classes = {
        'available': 'bg-success',
        'occupied': 'bg-danger',
        'out-of-service': 'bg-warning text-dark',
        'unknown': 'bg-secondary'
      };
      return classes[status] || 'bg-secondary';
    }

    function getMarkerColor(status) {
      const colors = {
        'available': '#198754',
        'occupied': '#dc3545',
        'out-of-service': '#ffc107',
        'unknown': '#6c757d'
      };
      return colors[status] || '#6c757d';
    }

    function getProgressBarClass(outlet) {
      const percentage = (outlet.availablePorts / outlet.totalPorts) * 100;
      if (percentage > 50) return 'bg-success';
      if (percentage > 0) return 'bg-warning';
      return 'bg-danger';
    }

    function getOutletTypeIcon(type) {
      const icons = {
        'standard': 'ðŸ”Œ',
        'usb': 'ðŸ“±',
        'usb-c': 'âš¡',
        'combination': 'ðŸ”‹'
      };
      return icons[type] || 'ðŸ”Œ';
    }
  </script>
</body>
</html>
