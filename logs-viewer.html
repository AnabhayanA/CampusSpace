<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Log Viewer - CampusSpace</title>
  
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  
  <style>
    body {
      font-family: 'Monaco', 'Courier New', monospace;
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
    }

    .log-viewer {
      background: #252526;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }

    .log-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #3e3e42;
    }

    .log-header h3 {
      color: #4fc3f7;
      margin: 0;
    }

    .log-controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .log-controls select,
    .log-controls input,
    .log-controls button {
      background: #3e3e42;
      color: #d4d4d4;
      border: 1px solid #555;
      padding: 8px 12px;
      border-radius: 4px;
    }

    .log-controls button {
      cursor: pointer;
      transition: background 0.3s;
    }

    .log-controls button:hover {
      background: #555;
    }

    .log-content {
      background: #1e1e1e;
      border: 1px solid #3e3e42;
      border-radius: 4px;
      padding: 15px;
      height: 600px;
      overflow-y: auto;
      font-size: 13px;
      line-height: 1.6;
    }

    .log-line {
      margin-bottom: 2px;
      padding: 4px;
      border-radius: 3px;
    }

    .log-line:hover {
      background: #2d2d30;
    }

    .log-ERROR {
      color: #f48771;
      background: rgba(244, 135, 113, 0.1);
    }

    .log-WARN {
      color: #dcdcaa;
      background: rgba(220, 220, 170, 0.1);
    }

    .log-INFO {
      color: #4fc3f7;
    }

    .log-DEBUG {
      color: #c586c0;
    }

    .timestamp {
      color: #808080;
    }

    .source {
      color: #4ec9b0;
      font-weight: bold;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: #2d2d30;
      padding: 15px;
      border-radius: 6px;
      text-align: center;
      border: 1px solid #3e3e42;
    }

    .stat-number {
      font-size: 2rem;
      font-weight: bold;
      color: #4fc3f7;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #808080;
      margin-top: 5px;
    }

    .search-highlight {
      background: #f4bf75;
      color: #000;
      padding: 2px 4px;
      border-radius: 2px;
    }

    ::-webkit-scrollbar {
      width: 10px;
    }

    ::-webkit-scrollbar-track {
      background: #1e1e1e;
    }

    ::-webkit-scrollbar-thumb {
      background: #555;
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #666;
    }
  </style>
</head>
<body>

  <div class="container-fluid">
    <div class="log-viewer">
      <!-- Header -->
      <div class="log-header">
        <h3><i class="bi bi-terminal"></i> CampusSpace Log Viewer</h3>
        <div>
          <button class="btn btn-sm" onclick="window.location.href='dashboard.html'">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
          </button>
        </div>
      </div>

      <!-- Stats -->
      <div class="stats">
        <div class="stat-card">
          <div class="stat-number" id="total-logs">0</div>
          <div class="stat-label">Total Entries</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="error-count" style="color: #f48771;">0</div>
          <div class="stat-label">Errors</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="warn-count" style="color: #dcdcaa;">0</div>
          <div class="stat-label">Warnings</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="api-requests">0</div>
          <div class="stat-label">API Requests</div>
        </div>
      </div>

      <!-- Controls -->
      <div class="log-controls">
        <select id="log-file" onchange="loadLogs()">
          <option value="app">app.log (All Logs)</option>
          <option value="access">access.log (API Requests)</option>
          <option value="error">error.log (Errors Only)</option>
          <option value="data-refresh">data-refresh.log (Data Updates)</option>
          <option value="room-availability">room-availability.log (Room Status)</option>
        </select>

        <select id="log-level" onchange="filterLogs()">
          <option value="all">All Levels</option>
          <option value="ERROR">Errors</option>
          <option value="WARN">Warnings</option>
          <option value="INFO">Info</option>
          <option value="DEBUG">Debug</option>
        </select>

        <input type="text" id="search-term" placeholder="Search logs..." onkeyup="filterLogs()">

        <button onclick="loadLogs()">
          <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>

        <button onclick="clearLogs()">
          <i class="bi bi-trash"></i> Clear Display
        </button>

        <button onclick="downloadLogs()">
          <i class="bi bi-download"></i> Download
        </button>

        <button onclick="toggleAutoRefresh()">
          <i class="bi bi-play-circle"></i> <span id="auto-refresh-text">Auto Refresh</span>
        </button>
      </div>

      <!-- Log Content -->
      <div class="log-content" id="log-content">
        <div style="text-align: center; color: #808080; padding: 40px;">
          <i class="bi bi-hourglass-split" style="font-size: 3rem;"></i>
          <p>Select a log file and click Refresh to view logs</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    let allLogs = [];
    let autoRefreshInterval = null;

    // Load logs
    async function loadLogs() {
      const logFile = document.getElementById('log-file').value;
      const logContent = document.getElementById('log-content');

      try {
        // In a real implementation, this would fetch from an API endpoint
        // For now, we'll show the example logs
        const response = await fetch(`/logs/${logFile}.log`);
        
        if (!response.ok) {
          throw new Error('Log file not found');
        }

        const text = await response.text();
        const lines = text.trim().split('\n').filter(line => line.trim());
        
        allLogs = lines.map((line, index) => ({
          id: index,
          raw: line,
          ...parsLogLine(line)
        }));

        updateStats();
        filterLogs();
      } catch (error) {
        // Show demo logs
        showDemoLogs();
      }
    }

    // Parse log line
    function parseLogLine(line) {
      const match = line.match(/\[(.*?)\] \[(.*?)\] \[(.*?)\] - (.*)/);
      if (match) {
        return {
          timestamp: match[1],
          level: match[2],
          source: match[3],
          message: match[4]
        };
      }
      return { timestamp: '', level: 'INFO', source: 'Unknown', message: line };
    }

    // Show demo logs
    function showDemoLogs() {
      const demoLogs = [
        '[2025-12-21 10:15:30.123] [INFO] [Server] - CampusSpace server started on port 3000',
        '[2025-12-21 10:15:30.456] [INFO] [DataRefresh] - Fetching course schedule from NJIT...',
        '[2025-12-21 10:15:32.789] [WARN] [DataRefresh] - No courses found from NJIT site',
        '[2025-12-21 10:15:32.890] [INFO] [DataRefresh] - Loading sample data as fallback...',
        '[2025-12-21 10:15:32.995] [INFO] [DataRefresh] - Loaded 27 sample courses',
        '[2025-12-21 10:16:45.123] [INFO] [API] - GET /api/health - 200 - 5ms',
        '[2025-12-21 10:16:52.456] [INFO] [API] - GET /api/rooms/availability - 200 - 125ms',
        '[2025-12-21 10:17:15.789] [INFO] [API] - GET /api/courses - 200 - 8ms',
        '[2025-12-21 10:20:00.678] [ERROR] [API] - GET /api/invalid-endpoint - 404 - 2ms',
        '[2025-12-21 11:00:00.000] [INFO] [DataRefresh] - Scheduled refresh started',
        '[2025-12-21 11:15:46.123] [INFO] [API] - GET /api/rooms/availability - 200 - 98ms',
        '[2025-12-21 12:15:30.890] [WARN] [API] - Slow request detected',
        '[2025-12-21 14:30:45.567] [INFO] [RoomAvailability] - Peak usage detected',
      ];

      allLogs = demoLogs.map((line, index) => ({
        id: index,
        raw: line,
        ...parseLogLine(line)
      }));

      updateStats();
      filterLogs();
    }

    // Filter logs
    function filterLogs() {
      const level = document.getElementById('log-level').value;
      const searchTerm = document.getElementById('search-term').value.toLowerCase();
      
      let filtered = allLogs;

      // Filter by level
      if (level !== 'all') {
        filtered = filtered.filter(log => log.level === level);
      }

      // Filter by search term
      if (searchTerm) {
        filtered = filtered.filter(log => 
          log.raw.toLowerCase().includes(searchTerm)
        );
      }

      displayLogs(filtered, searchTerm);
    }

    // Display logs
    function displayLogs(logs, highlight = '') {
      const logContent = document.getElementById('log-content');
      
      if (logs.length === 0) {
        logContent.innerHTML = '<div style="text-align: center; color: #808080; padding: 40px;">No logs match your filters</div>';
        return;
      }

      const html = logs.map(log => {
        let message = log.raw;
        
        // Highlight search term
        if (highlight) {
          const regex = new RegExp(`(${highlight})`, 'gi');
          message = message.replace(regex, '<span class="search-highlight">$1</span>');
        }

        return `<div class="log-line log-${log.level}">${message}</div>`;
      }).join('');

      logContent.innerHTML = html;
      logContent.scrollTop = logContent.scrollHeight;
    }

    // Update stats
    function updateStats() {
      document.getElementById('total-logs').textContent = allLogs.length;
      document.getElementById('error-count').textContent = allLogs.filter(l => l.level === 'ERROR').length;
      document.getElementById('warn-count').textContent = allLogs.filter(l => l.level === 'WARN').length;
      document.getElementById('api-requests').textContent = allLogs.filter(l => l.source === 'API').length;
    }

    // Clear logs display
    function clearLogs() {
      allLogs = [];
      document.getElementById('log-content').innerHTML = '<div style="text-align: center; color: #808080; padding: 40px;">Display cleared</div>';
      updateStats();
    }

    // Download logs
    function downloadLogs() {
      const logFile = document.getElementById('log-file').value;
      const content = allLogs.map(l => l.raw).join('\n');
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `campusspace-${logFile}-${new Date().toISOString().split('T')[0]}.log`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Toggle auto refresh
    function toggleAutoRefresh() {
      const button = document.querySelector('button[onclick="toggleAutoRefresh()"]');
      const text = document.getElementById('auto-refresh-text');

      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
        autoRefreshInterval = null;
        button.innerHTML = '<i class="bi bi-play-circle"></i> <span id="auto-refresh-text">Auto Refresh</span>';
      } else {
        autoRefreshInterval = setInterval(loadLogs, 5000);
        button.innerHTML = '<i class="bi bi-pause-circle"></i> <span id="auto-refresh-text">Stop Auto Refresh</span>';
      }
    }

    // Load demo logs on page load
    window.addEventListener('load', () => {
      showDemoLogs();
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
